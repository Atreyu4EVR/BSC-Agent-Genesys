<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BSC Agent Chat</title>
  <style>
    .feedback-buttons {
      margin-top: 6px;
      display: flex;
      gap: 8px;
    }
    .feedback-buttons button {
      font-size: 1.2em;
      cursor: pointer;
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 2px 8px;
      transition: background 0.2s;
    }
    .feedback-buttons button:hover {
      background: #e0e0e0;
    }
    .feedback-confirmation {
      font-size: 0.9em;
      color: #3b873e;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div id="n8n-chat"></div>

  <script src="https://cdn.jsdelivr.net/npm/@n8n/chat@1"></script>
  <script>
    // Initialize n8n chat
    const chat = new window.N8NChat({
      webhookUrl: 'https://byui.app.n8n.cloud/webhook/13348d82-88d3-447e-90d4-7b6db9f79280/chat', // Replace with your chat webhook
      containerSelector: '#n8n-chat'
    });

    // Helper to create feedback buttons
    function createFeedbackButtons(messageEl, messageId) {
      // Avoid adding feedback twice
      if (messageEl.querySelector('.feedback-buttons')) return;

      const feedbackDiv = document.createElement('div');
      feedbackDiv.className = 'feedback-buttons';

      const upBtn = document.createElement('button');
      upBtn.textContent = '👍';
      upBtn.onclick = () => sendFeedback(messageId, 'positive', feedbackDiv);

      const downBtn = document.createElement('button');
      downBtn.textContent = '👎';
      downBtn.onclick = () => sendFeedback(messageId, 'negative', feedbackDiv);

      feedbackDiv.appendChild(upBtn);
      feedbackDiv.appendChild(downBtn);
      messageEl.appendChild(feedbackDiv);
    }

    // Function to send feedback to n8n webhook
    function sendFeedback(messageId, rating, feedbackDiv) {
      fetch('https://YOUR_N8N_INSTANCE/webhook/feedback', { // <-- CHANGE THIS
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          messageId,
          rating,
          timestamp: new Date().toISOString()
        })
      }).then(() => {
        feedbackDiv.innerHTML = '<span class="feedback-confirmation">Thank you for your feedback!</span>';
      }).catch(() => {
        feedbackDiv.innerHTML = '<span class="feedback-confirmation" style="color:#a33;">Error sending feedback.</span>';
      });
    }

    // Observe chat container for new AI messages
    const chatContainer = document.querySelector('#n8n-chat');
    const observer = new MutationObserver(() => {
      // Select all AI messages that don't yet have feedback
      document.querySelectorAll('.n8n-chat-message[data-sender="ai"]:not([data-feedback-ready])').forEach(msgEl => {
        // Mark as processed
        msgEl.setAttribute('data-feedback-ready', 'true');
        // Use a timestamp or hash as a messageId (or enhance to use your own unique IDs)
        const messageId = msgEl.dataset.messageId || (
          msgEl.querySelector('.n8n-chat-message-content')
            ? msgEl.querySelector('.n8n-chat-message-content').innerText.slice(0,32)
            : (Date.now() + Math.random().toString(16).slice(2))
        );
        createFeedbackButtons(msgEl, messageId);
      });
    });
    observer.observe(chatContainer, { childList: true, subtree: true });
  </script>
</body>
</html>
